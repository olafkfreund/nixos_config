name: NixOS Configuration CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  check-configurations:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        host: [p620, razer, p510, samsung]
      fail-fast: false

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Nix
        uses: cachix/install-nix-action@v27
        with:
          nix_path: nixpkgs=channel:nixos-unstable
          extra_nix_config: |
            experimental-features = nix-command flakes
            accept-flake-config = true

      - name: Setup Magic Nix Cache
        uses: DeterminateSystems/magic-nix-cache-action@v7

      - name: Setup Cachix
        uses: cachix/cachix-action@v15
        with:
          name: nix-community
          authToken: '${{ secrets.CACHIX_AUTH_TOKEN }}'

      - name: Check flake
        run: nix flake check --show-trace

      - name: Build ${{ matrix.host }} configuration
        run: |
          nix build .#nixosConfigurations.${{ matrix.host }}.config.system.build.toplevel \
            --show-trace --print-build-logs

      - name: Check Home Manager configurations
        run: |
          if nix eval .#homeConfigurations.olafkfreund@${{ matrix.host }} 2>/dev/null; then
            nix build .#homeConfigurations.olafkfreund@${{ matrix.host }}.activationPackage \
              --show-trace --print-build-logs
          else
            echo "WARNING: No Home Manager configuration for olafkfreund@${{ matrix.host }}"
          fi

  security-check:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Nix
        uses: cachix/install-nix-action@v27
        with:
          extra_nix_config: |
            experimental-features = nix-command flakes
            accept-flake-config = true

      - name: Setup Magic Nix Cache
        uses: DeterminateSystems/magic-nix-cache-action@v7

      - name: Validate secrets structure
        run: |
          if [ -f "secrets.nix" ]; then
            echo "Validating secrets configuration..."
            if nix eval .#nixosConfigurations.p620.config.age.secrets --json > /dev/null 2>&1; then
              echo "PASS: Secrets configuration is valid"
            else
              echo "FAIL: Secrets configuration has errors"
              nix eval .#nixosConfigurations.p620.config.age.secrets --json
              exit 1
            fi
          else
            echo "WARNING: No secrets.nix found, skipping secrets validation"
          fi

      - name: Security scan
        run: |
          echo "Scanning for security issues..."

          # Check for hardcoded passwords (exclude safe patterns and archived code)
          if grep -r 'password\s*=\s*"[^"]\+"' . --include="*.nix" --exclude-dir=".git" --exclude-dir="archive" \
            | grep -v 'hashedPassword\|passwordFile\|password\s*=\s*""\|password\s*=\s*"nixos"\|onepassword\|secrets\|age\.secrets\|\$__file\|lib/live-images.nix\|modules/installer'; then
            echo "FAIL: Potential hardcoded passwords found"
            exit 1
          else
            echo "PASS: No hardcoded passwords found"
          fi

          # Check for hardcoded API keys (exclude safe patterns)
          if grep -r 'api.*key\s*=\s*"[^"]\+"' . --include="*.nix" --exclude-dir=".git" --exclude-dir="archive" \
            | grep -v 'secretFile\|apiKeyFile\|secrets\|age\.secrets'; then
            echo "FAIL: Potential hardcoded API keys found"
            exit 1
          else
            echo "PASS: No hardcoded API keys found"
          fi

          # Check for TODO/FIXME items
          todo_count=$(grep -r "TODO\|FIXME" . --include="*.nix" --exclude-dir=".git" --exclude-dir="archive" | wc -l)
          echo "INFO: Found $todo_count TODO/FIXME items"

  documentation-check:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Check documentation completeness
        run: |
          echo "Checking documentation..."

          # Check if README exists and has minimum content
          if [ -f "README.md" ] && [ $(wc -l < README.md) -gt 50 ]; then
            echo "PASS: README.md is present and substantial"
          else
            echo "WARNING: README.md is missing or too short"
          fi

          # Check for module documentation
          module_count=$(find modules/ -name "*.nix" 2>/dev/null | wc -l)
          doc_count=$(find docs/ -name "*.md" 2>/dev/null | wc -l)
          echo "INFO: Found $module_count modules and $doc_count documentation files"

          # Check docs folder structure
          if [ -d "docs" ] && [ -f "docs/README.md" ]; then
            echo "PASS: Documentation structure exists"
          else
            echo "WARNING: Documentation structure incomplete"
          fi

  lint-check:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Nix
        uses: cachix/install-nix-action@v27
        with:
          extra_nix_config: |
            experimental-features = nix-command flakes

      - name: Setup Magic Nix Cache
        uses: DeterminateSystems/magic-nix-cache-action@v7

      - name: Nix formatting check
        run: |
          echo "Checking Nix code formatting..."

          nix shell nixpkgs#nixpkgs-fmt -c bash -c '
            if find . -name "*.nix" -not -path "./.git/*" -exec nixpkgs-fmt --check {} + ; then
              echo "PASS: All Nix files are properly formatted"
            else
              echo "FAIL: Some Nix files need formatting"
              echo "Run: nixpkgs-fmt ."
              exit 1
            fi
          '

      - name: Nix linting check
        run: |
          echo "Linting Nix code..."

          nix shell nixpkgs#statix -c bash -c '
            if statix check . ; then
              echo "PASS: No linting issues found"
            else
              echo "WARNING: Linting issues detected"
            fi
          '

      - name: Dead code check
        run: |
          echo "Checking for dead code..."

          nix shell nixpkgs#deadnix -c bash -c '
            if deadnix --fail ; then
              echo "PASS: No dead code found"
            else
              echo "WARNING: Dead code detected"
            fi
          '

  pre-commit-check:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Nix
        uses: cachix/install-nix-action@v27
        with:
          extra_nix_config: |
            experimental-features = nix-command flakes

      - name: Setup Magic Nix Cache
        uses: DeterminateSystems/magic-nix-cache-action@v7

      - name: Run pre-commit hooks
        run: |
          echo "Running pre-commit hooks..."

          nix shell nixpkgs#pre-commit -c bash -c '
            pre-commit run --all-files || true
          '

          echo "INFO: Pre-commit check completed (non-blocking)"
