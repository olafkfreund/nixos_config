{ config, lib, pkgs, ... }:

with lib;
let
  cfg = config.gtk-cosmic-fix;

  # Button fixes CSS content - uses !important to override Adwaita defaults
  buttonFixCSS = ''
    /* Window control button sizing fix for GTK4/libadwaita apps */
    /* Forces smaller buttons to override Adwaita defaults */

    /* Target all window control buttons */
    windowcontrols button,
    windowcontrols > button,
    headerbar windowcontrols button,
    .titlebar windowcontrols button {
      min-height: 24px !important;
      min-width: 24px !important;
      max-height: 24px !important;
      max-width: 24px !important;
      padding: 2px !important;
      margin: 2px !important;
      border-radius: 50% !important;
    }

    /* Specific button types */
    windowcontrols button.close,
    windowcontrols button.maximize,
    windowcontrols button.minimize {
      min-height: 24px !important;
      min-width: 24px !important;
      max-height: 24px !important;
      max-width: 24px !important;
      padding: 2px !important;
    }

    /* Icon sizing inside buttons */
    windowcontrols button image,
    windowcontrols button > image,
    windowcontrols > button > image {
      -gtk-icon-size: 16px !important;
      min-width: 16px !important;
      min-height: 16px !important;
      max-width: 16px !important;
      max-height: 16px !important;
    }

    /* Reduce headerbar height */
    headerbar,
    .titlebar,
    headerbar.titlebar {
      min-height: 38px !important;
      padding-top: 2px !important;
      padding-bottom: 2px !important;
    }

    /* Box containing window controls */
    windowcontrols {
      margin: 0 !important;
      padding: 0 !important;
    }
  '';

  # Script to patch COSMIC's dark.css with Gruvbox import and button fixes
  patchScript = pkgs.writeShellScript "patch-cosmic-gtk" ''
    set -e
    DARK_CSS="$HOME/.config/gtk-4.0/cosmic/dark.css"
    GRUVBOX_CSS="$HOME/.local/share/themes/Gruvbox-Material-Dark/gtk-4.0/gtk.css"
    ORIGINAL_BACKUP="$HOME/.config/gtk-4.0/cosmic/dark.css.original"

    # Only patch if Gruvbox theme exists
    if [ ! -f "$GRUVBOX_CSS" ]; then
      echo "Gruvbox theme not found, skipping"
      exit 0
    fi

    # Create cosmic directory if needed
    mkdir -p "$HOME/.config/gtk-4.0/cosmic"

    # Check if already fully patched
    if grep -q "Window control button sizing fix" "$DARK_CSS" 2>/dev/null; then
      echo "Already patched with button fixes, skipping"
      exit 0
    fi

    echo "Patching COSMIC GTK CSS..."

    # Save original COSMIC file if this is the first time
    # (original file starts with "/* GENERATED BY COSMIC */")
    if [ -f "$DARK_CSS" ] && grep -q "GENERATED BY COSMIC" "$DARK_CSS" 2>/dev/null; then
      echo "Saving original COSMIC CSS..."
      cp "$DARK_CSS" "$ORIGINAL_BACKUP"
    fi

    # Build the patched file
    # Structure: Gruvbox import + COSMIC colors (from original) + button fixes
    {
      echo '@import url("file:///home/${cfg.username}/.local/share/themes/Gruvbox-Material-Dark/gtk-4.0/gtk.css");'
      echo ""

      # Include original COSMIC color definitions if we have them
      if [ -f "$ORIGINAL_BACKUP" ]; then
        echo "/* COSMIC color overrides */"
        cat "$ORIGINAL_BACKUP"
        echo ""
      fi

      echo "${buttonFixCSS}"
    } > "$DARK_CSS"

    echo "GTK CSS patched successfully"
  '';
in
{
  options.gtk-cosmic-fix = {
    enable = mkEnableOption "COSMIC GTK theme fix (merges Gruvbox with COSMIC colors)";

    username = mkOption {
      type = types.str;
      default = "olafkfreund";
      description = "Username for path resolution";
    };
  };

  config = mkIf cfg.enable {
    # Systemd path unit to watch for changes to dark.css
    systemd.user.paths.cosmic-gtk-watcher = {
      Unit = {
        Description = "Watch COSMIC GTK CSS for changes";
      };
      Path = {
        PathChanged = "%h/.config/gtk-4.0/cosmic/dark.css";
        Unit = "cosmic-gtk-patcher.service";
      };
      Install = {
        WantedBy = [ "default.target" ];
      };
    };

    # Systemd service to patch the CSS
    systemd.user.services.cosmic-gtk-patcher = {
      Unit = {
        Description = "Patch COSMIC GTK CSS with Gruvbox theme";
      };
      Service = {
        Type = "oneshot";
        ExecStart = "${patchScript}";
        # Small delay to ensure COSMIC finished writing
        ExecStartPre = "${pkgs.coreutils}/bin/sleep 1";
      };
    };

    # Also run on login to ensure it's patched
    systemd.user.services.cosmic-gtk-patcher-init = {
      Unit = {
        Description = "Initial patch of COSMIC GTK CSS with Gruvbox theme";
        After = [ "graphical-session.target" ];
      };
      Service = {
        Type = "oneshot";
        ExecStart = "${patchScript}";
        # Delay to let COSMIC initialize
        ExecStartPre = "${pkgs.coreutils}/bin/sleep 3";
      };
      Install = {
        WantedBy = [ "graphical-session.target" ];
      };
    };
  };
}
